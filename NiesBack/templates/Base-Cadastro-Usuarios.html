{% extends "base.html" %}
{% block content %}



<!--Styles Necessários-->
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/mdi/css/materialdesignicons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/css/vendor.bundle.base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/jvectormap/jquery-jvectormap.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/flag-icon-css/css/flag-icon.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/owl-carousel-2/owl.carousel.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/owl-carousel-2/owl.theme.default.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/select2/select2.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/vendors/select2-bootstrap-theme/select2-bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='assets/css/style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', path='assets/images/favicon.png') }}" />



<!--Scripts necessários:-->
    <script src="{{ url_for('static', path='assets/vendors/js/vendor.bundle.base.js') }}"></script>
    <script src="{{ url_for('static', path='assets/vendors/chart.js/Chart.min.js') }}"></script>
    <script src="{{ url_for('static', path='assets/vendors/progressbar.js/progressbar.min.js') }}"></script>
    <script src="{{ url_for('static', path='assets/vendors/jvectormap/jquery-jvectormap.min.js') }}"></script>
    <script src="{{ url_for('static', path='assets/vendors/jvectormap/jquery-jvectormap-world-mill-en.js') }}"></script>
    <script src="{{ url_for('static', path='assets/vendors/owl-carousel-2/owl.carousel.min.js') }}"></script>
    <script src="{{ url_for('static', path='assets/vendors/select2/select2.min.js') }}"></script>
    <script src="{{ url_for('static', path='assets/vendors/typeahead.js/typeahead.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/off-canvas.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/hoverable-collapse.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/misc.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/settings.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/todolist.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/dashboard.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/chart.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/file-upload.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/typeahead.js') }}"></script>
    <script src="{{ url_for('static', path='assets/js/select2.js') }}"></script>



<!--INICIO DO MAIN - CADASTRO DE PAINEIS (GRUPOS, SUBGRUPOS E PAINEIS)-->
<div class="row">
  <div class="row">
    <div class="col-md-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Grupo de Usuário</h4>
          <p class="card-description"> Cadastre os grupos de Usuário </p>
          <form class="forms-sample">
            <div class="form-group">
              <label for="exampleInputUsername1">Nome do Grupo</label>
              <input type="text" class="form-control" id="exampleInputUsername1" placeholder="Nome do Grupo">
            </div>
            <div class="form-group">
              <label for="exampleTextarea1">Descrição do Grupo</label>
              <textarea class="form-control" id="exampleTextarea1" rows="4"></textarea>
            </div>
            
            <div class="form-group">
              <p class="card-description">Grupos de Paineis Permitidos</p>
            <form>
              <div class="row justify-content-between">
                {%for g in groups %}
                    <div class="form-check">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" > {{g.name}} </label>
                    </div>
                {% endfor %}
                  {% if groups|length == 0 %}
                    <div class="text-muted">Nenhum grupo cadastrado.</div>
                  {% endif %}                            
              </div>
        <button type="submit" class="btn btn-primary mr-2">Cadastrar Usuário</button>
            </form>
            </div>
            </form>
        </div>
      </div>
    </div>
    <div class="col-md-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Paineis Permitidos (Nível de Acesso)</h4>
          <p class="card-description"> Selecione os Paineis Permitidos </p>
          <form>
            <p class="card-description"> Painéis Privados </p>
              <div id="reportsContainer" class="row">
                  {%for r in reports_private %}
                    <div class="form-check">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="report" value="{{ r.id }}" > {{r.name}} </label>
                    </div>
                  {% endfor %}
                  {% if reports_private|length == 0 %}
                    <div class="text-muted">Nenhum relatório cadastrado.</div>
                  {% endif %}     
              </div>
            

          </form>
          
        </div>
      </div>
    </div>    
  </div>

  <script>
  const API_BASE =
    ("{{ request.url_for('static', path='') }}".replace(/\/static\/?$/, "/")) ||
    "http://127.0.0.1:8000/";

    console.log("API_BASE =", API_BASE);

  function getCheckedReportIds() {
    return Array.from(document.querySelectorAll('input[name="report"]:checked')).map(i => i.value);
  }

  function setCheckedReportIds(ids) {
    const set = new Set(ids);
    document.querySelectorAll('input[name="report"]').forEach(i => {
      i.checked = set.has(i.value);
    });
  }

  async function loadExistingUserGroups() {
    try {
      const resp = await fetch(`${API_BASE}api/admin/user-groups`, { credentials: "include" });
      if (!resp.ok) throw new Error("Falha ao listar grupos de usuário.");
      const groups = await resp.json(); // [{id, name, description}]
      const wrap = document.getElementById("existingUserGroups");
      wrap.innerHTML = "";
      groups.forEach(g => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-primary btn-sm";
        btn.textContent = g.name;
        btn.dataset.groupId = g.id;
        btn.addEventListener("click", () => onClickUserGroup(g.id));
        wrap.appendChild(btn);
      });
    } catch (e) {
      console.error(e);
    }
  }

  async function onClickUserGroup(groupId) {
    try {
      const resp = await fetch(`${API_BASE}api/admin/user-groups/${groupId}/report-ids`, { credentials: "include" });
      if (!resp.ok) throw new Error("Falha ao obter permissões do grupo.");
      const reportIds = await resp.json(); // lista de ids
      setCheckedReportIds(reportIds);
    } catch (e) {
      console.error(e);
      alert("Não foi possível carregar os BI desse grupo.");
    }
  }

  // Handler do botão "Cadastrar Usuário" (criar grupo + permissões)
  document.querySelector('button[type="submit"]')?.addEventListener("click", async (e) => {
    e.preventDefault();
    const name = document.getElementById("exampleInputUsername1").value.trim();
    const description = document.getElementById("exampleTextarea1").value.trim();
    const report_ids = getCheckedReportIds();

    if (!name) {
      alert("Informe o nome do grupo de usuário.");
      return;
    }

    const payload = { name, description: description || null, report_ids };

    try {
      const resp = await fetch(`${API_BASE}api/admin/user-groups`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
      });
      if (resp.status === 409) {
        const err = await resp.json();
        alert(err.detail || "Já existe um grupo com esse nome.");
        return;
      }
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro ao criar o grupo.");
      }
      const data = await resp.json();
      alert("Grupo criado com sucesso!");
      setTimeout(() => {
        window.location.reload(); // <<--- RELOAD AQUI
      }, 150);
      // ressincroniza lista de grupos existentes
      await loadExistingUserGroups();
      // limpa campos/seleção
      document.getElementById("exampleInputUsername1").value = "";
      document.getElementById("exampleTextarea1").value = "";
      setCheckedReportIds([]);
    } catch (err) {
      console.error(err);
      alert(err.message);
    }
  });

  // inicia carregando grupos já existentes
  loadExistingUserGroups();
</script>


{% endblock %}
<!--FIM DO MAIN-->